<?php require("config.php"); require("config_paypal.php");  if ($server_core=='')  $server_core='ascent'; require_once './include/core/'.$server_core.'.php';  if(function_exists("date_default_timezone_set") and function_exists("date_default_timezone_get")) @date_default_timezone_set(@date_default_timezone_get()); set_time_limit(15); function handlePayment() {  global $db_host,$db_user,$db_pass,$db_name,$acc_db,$db_translation;  $Con = mysql_connect($db_host,$db_user,$db_pass);  mysql_select_db($db_name,$Con);    $Itemcount = ceil($_POST['quantity']);  $acctid=$_POST['item_number'];  $Money = (float)$_POST['mc_gross'];    /*Prevent txnid recycling.*/  $res = mysql_query("SELECT COUNT(*) FROM paypal_data WHERE txnid = '{$_POST['txn_id']}'",$Con);  if(mysql_result($res,0) != 0)  {   mysql_query("INSERT INTO paypal_data (login,txnid,amount,who,whendon,comment) VALUES ('{$_POST['item_number']}','{$_POST['txn_id']}','{$_POST['mc_gross']}','{$_POST['payer_email']}','".date("U")."','Fail: This transaction id is a duplicate.')",$Con);   die;  }    /*Check payment status.*/  if($_POST['payment_status'] != "Completed")  {   mysql_query("INSERT INTO paypal_data (login,txnid,amount,who,whendon,comment) VALUES ('{$_POST['item_number']}','{$_POST['txn_id']}','{$_POST['mc_gross']}','{$_POST['payer_email']}','".date("U")."','<span class=\"colorbad\">Fail:</span> This transaction is not completed but ".$_POST['payment_status'].".')",$Con);   die;  }    /*log time*/  $Info = "<span class=\"colorgood\">Successful transaction!</span>";    /*select users points*/  mysql_select_db($acc_db,$Con);  $query1_a=mysql_query("SELECT ".$db_translation['login']." FROM ".$db_translation['accounts']." WHERE ".$db_translation['acct']."='".$acctid."' LIMIT 1",$Con);  if (mysql_num_rows($query1_a)=='0')  {    $Info.='<br><span class=\"colorbad\">Invalid account. (accounts table) DB: "'.$acc_db.'". SQL: '."SELECT ".$db_translation['login']." FROM ".$db_translation['accounts']." WHERE ".$db_translation['acct']."=\'".$acctid."\' LIMIT 1</span>";  }  else  {   $query_a=mysql_fetch_assoc($query1_a);   mysql_select_db($db_name,$Con);   /*select current donation points*/   $query1_b=mysql_query("SELECT dp FROM accounts_more WHERE acc_login='".$query_a[$db_translation['login']]."' LIMIT 1",$Con);   if (mysql_num_rows($query1_b)=='0')   {     $Info.='<br><span class=\"colorbad\">No additional data! (accounts_more table) DB: "'.$db_name.'". SQL: '."SELECT dp FROM accounts_more WHERE acc_login=\'".$query_a[$db_translation['login']]."\' LIMIT 1</span>";   }   else   {    $query_b=mysql_fetch_assoc($query1_b);    mysql_select_db($db_name,$Con);    /*select current donation points*/    /*add points, but compare moneydonated with itemcout*/    if ($Money<>$Itemcount)    {     $Info.='<br><span class=\"colorbad\">Hack attempt:</span> Money donated ('.$Money.') is not equal to number of items ('.$Itemcount.')';    }    else    {     mysql_query("UPDATE accounts_more SET dp='".($query_b['dp']+$Itemcount)."' WHERE acc_login= '". $query_a[$db_translation['login']]."' LIMIT 1",$Con);     $Info.='<br>Query executed: '."UPDATE accounts_more SET dp=\'".($query_b['dp']+$Itemcount)."\'  WHERE acc_login= \'". $query_a[$db_translation['login']]."\' LIMIT 1<br>Everyhing went successfully.";    }   }  }  mysql_select_db($db_name,$Con);  /*finally add to log*/  mysql_query("INSERT INTO paypal_data (login,txnid,amount,who,whendon,comment) VALUES ('{$_POST['item_number']}','{$_POST['txn_id']}','{$_POST['mc_gross']}','{$Itemcount}[|]{$_POST['payer_email']}','".date("U")."','{$Info}')",$Con);  mysql_close($Con); }  function handleInvalidPayment() {  global $db_host,$db_user,$db_pass,$db_name;  $Con = mysql_connect($db_host,$db_user,$db_pass);  mysql_select_db($db_name,$Con);    $Info = "";  foreach($_POST as $key => $value)  {   $Info .= "{$key} = {$value} <br>\n";  }  mysql_query("INSERT INTO paypal_data (whendon,comment) VALUES ('".date("U")."','An invalid request was made. Postdata info:<br>\n{$Info}')",$Con);  mysql_close($Con); }  function verifyPayment() {  global $paypalurl;  if(sizeof($_POST) == 0)  {   /*dont bother, maybe an accidental page visit.*/   ?><h1>Restricted Area</h1>   <p>You are not permitted to access this page.</p><?php   return;  }  $Postback = "cmd=_notify-validate";  /*test_file($Postback);*/  foreach($_POST as $key => $value)  {   $key = urlencode(stripslashes($key));   $value = urlencode(stripslashes($value));   $Postback .= "&{$key}={$value}";  }  echo $Postback;    $Sock = fsockopen($paypalurl,80,$errno,$errstr,5);  if(!$Sock)  {   handleInvalidPayment();  }  $Head .= "POST /cgi-bin/webscr HTTP/1.0\r\n";  $Head .= "Content-type: application/x-www-form-urlencoded\r\n";  $Head .= "Content-length: ".strlen($Postback)."\r\n\r\n";  fputs($Sock,$Head.$Postback,strlen($Head.$Postback));  while(!feof($Sock))  {   $txt = fgets($Sock,1024);   if(strcmp($txt,"VERIFIED") == 0)   {    echo 'ver';handlePayment();   }   elseif(strcmp($txt,"INVALID") == 0)   {    echo 'invalid';handleInvalidPayment();   }         }  fclose($Sock);   } function test_file($string) {  $myFile = "postback.log";  $fh = fopen($myFile, 'w') or die("can't open file");  $stringData = $string."\n";  fwrite($fh, $stringData);  fclose($fh); } if ($se_c<>'baf9abece3482c2236e47291d35ac07e') exit;  verifyPayment();   ?>